<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <link rel="import" type="text/html" href="../html/lib/include.html" />
        <!-- Include Google Map -->
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC1j-b_PdubJrPoK9rX26VKRnWUpR4nd9c"></script>
        <!--<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&amp;language=en">-->

        <!-- Include gMap3 -->
        <script src="../js/libs/gmap3/gmap3.min.js" type="text/javascript"></script>
        <script>
            $(document).ready(function () {
                var map = $("#gmap");

                $(".showLookup").selectable();

                map.gmap3({
                    map: {
                        options: {
                            zoom: 12,
                            center: [14.0357283, 100.734549]
                        }
                    }
                });

                $.post(url + "Crime/query", function (data) {
                    var markers = data.Records;
                    var clearList;

                    $(".showLookup").on("selectableselected", function (event, ui) {
                        var item = $(this);
                        clearList = new Array();

                        item.find('*').each(function (data) {
                            clearList.push(item.attr("itemId") + "_" + $(this).attr("pk"));
                        });

                        item.find('.ui-selected').each(function () {
                            clearList.splice(clearList.indexOf(item.attr("itemId") + "_" + $(this).attr("pk")), 1);

                        });

                        console.log("Set Markers");
                        setMarkers();
                    });


                    setMarkers();
                    function setMarkers() {
                        map.gmap3({
                            clear: {
                                name: "marker"
                            }
                        });

                        $.each(markers, function () {
                            map.gmap3({
                                marker: {
                                    values: [
                                        {
                                            tag: [
                                                "Type_" + this.type_pk
                                            ],
                                            latLng: [this.crime_lat, this.crime_lng],
                                            options: {
                                                icon: "/Web-app/img/marker/" + this.type_pk + ".png"
                                            }
                                        }
                                    ]
                                }
                            });
                        });

                        map.gmap3({
                            clear: {
                                tag: clearList
                            }
                        });
                    }
                });
            });
        </script>

        <style>
            div {
                display: block;
            }
            #menu {
                width: 30%;
                height: 100%;
            }
            #gmap {
                width: 1024px;
                height: 800px;
            }

            #feedback { font-size: 1.4em; }
            #selectable .ui-selecting { background: #FECA40; }
            #selectable .ui-selected { background: #F39814; color: white; }
            #selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
            #selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; }
        </style>
    </head>
    <body>
        <div id="menu">
            <div>Menu</div>
            <ol class="showLookup" size="5" itemid="Type">
                <li class="ui-widget-content ui-selected" pk="[pk]" >[name]</li>
            </ol>
        </div>
        <div id="gmap" class="gmap3"></div>
    </body>
    <script src="../js/libs/my.js" type="text/javascript"></script>
</html>
