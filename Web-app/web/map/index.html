<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="import" type="text/html" href="../lib/main.html" />

        <!-- Include Google Map -->
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC1j-b_PdubJrPoK9rX26VKRnWUpR4nd9c&libraries=visualization"></script>

        <!-- Include gMap3 -->
        <script src="../js/libs/gmap3/gmap3.min.js" type="text/javascript"></script>
        <script>
            $(function () {
                var map = $("#gmap");
                var heatmap = new google.maps.visualization.HeatmapLayer();
                var isHeatmap = false;

                $("#menuType").selectable();

                map.gmap3({
                    map: {
                        options: {
                            zoom: 12,
                            center: [14.0357283, 100.734549]
                        }
                    }
                });

                $(".showLookup").selectable();
                $('#dialogArea').dialog();
                $('#dialogPlace').dialog();
                $('#dialogType').dialog();
                $('#dialogTime').dialog();
                $('#dialogCheckPoint').dialog();

                $('#dialogArea').add('#dialogPlace')
                        .add('#dialogType').add('#dialogTime').add('#dialogCheckPoint')
                        .on("dialogclose", function (event, ui) {
                            loadData();
                        });

                $('#butMapType').on('click', function () {
                    isHeatmap = !isHeatmap;
                    loadData();
                });

                loadData();
                function loadData() {
                    var param = {};
                    var beforId;
                    var value = [];
                    var i = 0;
                    $('.showLookup').find('.ui-selected').each(function () {
                        var itemId = $(this).closest($('.showLookup')).attr('itemid');
                        itemId = itemId.charAt(0).toLowerCase() + itemId.slice(1);
                        var pk = $(this).attr('pk');
                        if (itemId != beforId && beforId != 'undefined') {
                            param[beforId] = value;
                            value = [];
                            i = 0;
                        }
                        value[i++] = pk;
                        beforId = itemId;
                    });
                    param[beforId] = value;

                    $.get(url + "Crime/query?parameter=" + JSON.stringify(param), function (data) {
                        var markers = [];

                        map.gmap3({
                            clear: {
                                name: "marker"
                            },
                            map: {
                                callback: function (map) {
                                    heatmap.setMap(null);
                                }
                            }
                        });

                        if (isHeatmap) {
                            var heatmapData = [];
                            $.each(data.Records, function () {
                                heatmapData.push(
                                        new google.maps.LatLng(this.crime_lat, this.crime_lng)
                                        );
                            });
                            var pointArray = new google.maps.MVCArray(heatmapData);
                            heatmap = new google.maps.visualization.HeatmapLayer({
                                data: pointArray
                            });

                            map.gmap3({
                                map: {
                                    callback: function (map) {
                                        heatmap.setMap(map);
                                    }
                                }
                            });
                        } else {
                            $.each(data.Records, function () {
                                markers.push({
                                    id: this.pk,
                                    latLng: [this.crime_lat, this.crime_lng],
                                    options: {
                                        icon: new google.maps.MarkerImage("/marker/" + this.type_pk + ".png")
                                    }
                                });
                            });

                            map.gmap3({
                                marker: {
                                    values: markers,
                                    events: {
                                        click: function (marker, event, context) {
                                            window.location.replace("../crime/index.html?pk=" + context.id);
                                        }
                                    },
                                    cluster: {
                                        radius: 100,
                                        0: {
                                            content: "<div class='cluster cluster-1'><h1>CLUSTER_COUNT</h1></div>"
                                        }
                                    }
                                }
                            });
                        }
                    });
                }
            });
        </script>
        <style>
            #gmap {
                width: 1024px;
                height: 800px;
            }
        </style>
    </head>
    <body>
        <a href="#" onclick="$('#dialogArea').dialog('open');" >เขตพื้นที่</a>
        <a href="#" onclick="$('#dialogPlace').dialog('open');" >ประเภทสถานที่</a>
        <a href="#" onclick="$('#dialogTime').dialog('open');" >ช่วงเวลาเกิดเหตุ</a>
        <a href="#" onclick="$('#dialogType').dialog('open');" >ประเภทคดี</a>
        <a href="#" onclick="$('#dialogCheckPoint').dialog('open');" >จุดตรวจ</a>


        <!-- *************************************************************** -->
        <div id="dialogPlace" title="ประเภทสถานที่">
            <ol id="selectable" class="showLookup" itemid="Place">
                <li class="ui-widget-content ui-selected" pk="[pk]" >[name]</li>
            </ol>
        </div>
        <div id="dialogArea" title="เขตพื้นที่">
            <ol id="selectable" class="showLookup" itemid="Area">
                <li class="ui-widget-content ui-selected" pk="[pk]" >[name]</li>
            </ol>
        </div>
        <div id="dialogTime" title="ช่วงเวลาเกิดเหตุ<">
            <ol id="selectable" class="showLookup" itemid="Time">
                <li class="ui-widget-content ui-selected" pk="[pk]" >[time_length]</li>
            </ol>
        </div>
        <div id="dialogType" title="ประเภทคดี">
            <ol id="selectable" class="showLookup" itemid="Type">
                <li class="ui-widget-content ui-selected" pk="[pk]" >[name]</li>
            </ol>
        </div>
        <div id="dialogCheckPoint" title="จุดตรวจ">
            <ol id="selectable" class="showLookup" itemid="CheckPoint">
                <li class="ui-widget-content ui-selected" pk="[pk]" >[name]</li>
            </ol>
        </div>
        <div id="butMapType">Map Type</div>
        <div id="gmap" class="gmap3"></div>
    </body>
    <script src="../js/libs/my.js" type="text/javascript"></script>
</html>
